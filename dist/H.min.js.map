{"version":3,"file":"H.min.js","sources":["../src/stage/stage.ts","../src/utils/uid.ts","../src/index.ts","../src/display/display-object.ts"],"sourcesContent":["import DisplayObject from '../display/display-object';\r\n\r\nfunction createCanvas(width: number = 300, height: number = 150): HTMLCanvasElement {\r\n  const canvas: HTMLCanvasElement = document.createElement('canvas');\r\n  canvas.setAttribute('width', String(width));\r\n  canvas.setAttribute('height', String(height));\r\n  canvas.style.cssText = 'position: absolute; top: 0; left: 0;';\r\n  return canvas;\r\n}\r\n\r\nclass Stage {\r\n  private container: HTMLElement;\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private cacheCanvas: HTMLCanvasElement;\r\n  private cacheCtx: CanvasRenderingContext2D;\r\n  private forceRender: boolean = false;\r\n\r\n  public width: number;\r\n  public height: number;\r\n  public objects: Array<DisplayObject> = [];\r\n\r\n  public constructor(options: { el: HTMLElement | string, width?: number, height?: number }) {\r\n    const el = options.el;\r\n    const width = +options.width || 300;\r\n    const height = +options.height || 150;\r\n\r\n    // canvas container\r\n    this.container = typeof el === 'string' ? document.querySelector(el) : el;\r\n    this.container.style.width = width + 'px';\r\n    this.container.style.height = height + 'px';\r\n    this.container.style.position = 'relative';\r\n    this.width = width;\r\n    this.height = height;\r\n\r\n    // canvas\r\n    const canvas: HTMLCanvasElement = createCanvas(width, height);\r\n    this.canvas = canvas;\r\n    this.ctx = canvas.getContext('2d');\r\n    this.container.appendChild(canvas);\r\n\r\n    // cache canvas\r\n    const cacheCanvas = createCanvas(width, height);\r\n    this.cacheCanvas = cacheCanvas;\r\n    this.cacheCtx = cacheCanvas.getContext('2d');\r\n\r\n    requestAnimationFrame(this.loopAnim.bind(this));\r\n  }\r\n\r\n  private loopAnim() {\r\n    this.renderObjects();\r\n    requestAnimationFrame(this.loopAnim.bind(this));\r\n  }\r\n\r\n  private renderObjects() {\r\n    if (!this.forceRender\r\n      && this.objects.every(el => !el.visible || !el.needUpdate())) {\r\n      return;\r\n    }\r\n    this.cacheCtx.clearRect(0, 0, this.width, this.height);\r\n    this.objects.forEach(el => {\r\n      el.visible && el.render(this.cacheCtx);\r\n    });\r\n    this.ctx.clearRect(0, 0, this.width, this.height);\r\n    this.ctx.drawImage(this.cacheCanvas, 0, 0);\r\n    this.forceRender = false;\r\n  }\r\n\r\n  /**\r\n   * add object to stage\r\n   */\r\n  public add(): Stage {\r\n    this.objects.push(...arguments);\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * remove object from stage by object id\r\n   */\r\n  public remove(objectId: number): Stage {\r\n    for (let i = 0; i < this.objects.length; i++) {\r\n      if (this.objects[i].id === objectId) {\r\n        this.objects.splice(i, 1);\r\n        this.forceRender = true;\r\n        break;\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n}\r\n\r\nexport default Stage;","let uid = 1;\n\nexport default {\n  gen() {\n    return uid++;\n  }\n};","import Stage from './stage/stage';\r\nimport DisplayObject from './display/display-object';\r\n\r\nconst H = {\r\n  Stage,\r\n  DisplayObject\r\n};\r\n\r\nexport default H;","import UID from '../utils/uid';\r\n\r\nexport default class DisplayObject {\r\n  readonly type: string = 'displayObject';\r\n  readonly id: number;\r\n  readonly proxy: any;\r\n  readonly updateList: Array<string> = ['visible', 'left', 'top'];\r\n\r\n  private updateFlag: boolean = false;\r\n\r\n  public visible: boolean = true;\r\n  public left: number = 0;\r\n  public top: number = 0;\r\n\r\n  public constructor(options: { left: number, top: number }) {\r\n    this.id = UID.gen();\r\n    this.proxy = new Proxy(this, {\r\n      get: (target, key, receiver) => {\r\n        return Reflect.get(target, key, receiver);\r\n      },\r\n      set: (target, key, value, receiver) => {\r\n        if (this.updateList.indexOf(String(key)) !== -1) {\r\n          this.updateFlag = true;\r\n        }\r\n        return Reflect.set(target, key, value, receiver);\r\n      }\r\n    });\r\n    this.set(options);\r\n\r\n    return this.proxy;\r\n  }\r\n\r\n  public set(options: any) {\r\n    if (typeof options === 'object') {\r\n      for (let key in options) {\r\n        if (options.hasOwnProperty(key)) {\r\n          this.proxy[key] = options[key];\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public needUpdate(): boolean {\r\n    return this.updateFlag;\r\n  }\r\n\r\n  public render(ctx: CanvasRenderingContext2D): void {\r\n    this.updateFlag = false;\r\n  }\r\n\r\n}\r\n"],"names":["createCanvas","width","height","canvas","document","createElement","setAttribute","String","style","cssText","uid","gen","Stage","options","this","el","container","querySelector","position","ctx","getContext","appendChild","cacheCanvas","cacheCtx","requestAnimationFrame","loopAnim","bind","renderObjects","forceRender","objects","every","visible","needUpdate","clearRect","forEach","render","_this","drawImage","_a","push","arguments","objectId","i","length","id","splice","DisplayObject","UID","proxy","Proxy","get","target","key","receiver","Reflect","set","value","updateList","indexOf","updateFlag","hasOwnProperty"],"mappings":"iNAEA,SAASA,EAAaC,EAAqBC,gBAArBD,oBAAqBC,OACzC,IAAMC,EAA4BC,SAASC,cAAc,UAIzD,OAHAF,EAAOG,aAAa,QAASC,OAAON,IACpCE,EAAOG,aAAa,SAAUC,OAAOL,IACrCC,EAAOK,MAAMC,QAAU,uCAChBN,EAGT,ICVIO,EAAM,KAGRC,eACE,OAAOD,aCATE,iBFkBA,WAAmBC,GANXC,kBAAuB,EAIxBA,gBAGL,IAAMC,EAAKF,EAAQE,GACbd,GAASY,EAAQZ,OAAS,IAC1BC,GAAUW,EAAQX,QAAU,IAGlCY,KAAKE,UAA0B,iBAAPD,EAAkBX,SAASa,cAAcF,GAAMA,EACvED,KAAKE,UAAUR,MAAMP,MAAQA,EAAQ,KACrCa,KAAKE,UAAUR,MAAMN,OAASA,EAAS,KACvCY,KAAKE,UAAUR,MAAMU,SAAW,WAChCJ,KAAKb,MAAQA,EACba,KAAKZ,OAASA,EAGd,IAAMC,EAA4BH,EAAaC,EAAOC,GACtDY,KAAKX,OAASA,EACdW,KAAKK,IAAMhB,EAAOiB,WAAW,MAC7BN,KAAKE,UAAUK,YAAYlB,GAG3B,IAAMmB,EAActB,EAAaC,EAAOC,GACxCY,KAAKQ,YAAcA,EACnBR,KAAKS,SAAWD,EAAYF,WAAW,MAEvCI,sBAAsBV,KAAKW,SAASC,KAAKZ,OA8C7C,OA3CUF,qBAAR,WACEE,KAAKa,gBACLH,sBAAsBV,KAAKW,SAASC,KAAKZ,QAGnCF,0BAAR,WAAA,YACOE,KAAKc,aACLd,KAAKe,QAAQC,MAAM,SAAAf,GAAM,OAACA,EAAGgB,UAAYhB,EAAGiB,iBAGjDlB,KAAKS,SAASU,UAAU,EAAG,EAAGnB,KAAKb,MAAOa,KAAKZ,QAC/CY,KAAKe,QAAQK,QAAQ,SAAAnB,GACnBA,EAAGgB,SAAWhB,EAAGoB,OAAOC,EAAKb,YAE/BT,KAAKK,IAAIc,UAAU,EAAG,EAAGnB,KAAKb,MAAOa,KAAKZ,QAC1CY,KAAKK,IAAIkB,UAAUvB,KAAKQ,YAAa,EAAG,GACxCR,KAAKc,aAAc,IAMdhB,gBAAP,iBAGE,OAFA0B,EAAAxB,KAAKe,SAAQU,wBAAQC,YAEd1B,MAMFF,mBAAP,SAAc6B,GACZ,IAAK,IAAIC,EAAI,EAAGA,EAAI5B,KAAKe,QAAQc,OAAQD,IACvC,GAAI5B,KAAKe,QAAQa,GAAGE,KAAOH,EAAU,CACnC3B,KAAKe,QAAQgB,OAAOH,EAAG,GACvB5B,KAAKc,aAAc,EACnB,MAIJ,OAAOd,WEpFTgC,yBCSA,WAAmBjC,GAAnB,WAeE,OA1BOC,UAAe,gBAGfA,iBAA6B,UAAW,OAAQ,OAEjDA,iBAAsB,EAEvBA,cAAmB,EACnBA,UAAe,EACfA,SAAc,EAGnBA,KAAK8B,GAAKG,EAAIpC,MACdG,KAAKkC,MAAQ,IAAIC,MAAMnC,MACrBoC,IAAK,SAACC,EAAQC,EAAKC,GACjB,OAAOC,QAAQJ,IAAIC,EAAQC,EAAKC,IAElCE,IAAK,SAACJ,EAAQC,EAAKI,EAAOH,GAIxB,OAH8C,IAA1CjB,EAAKqB,WAAWC,QAAQnD,OAAO6C,MACjChB,EAAKuB,YAAa,GAEbL,QAAQC,IAAIJ,EAAQC,EAAKI,EAAOH,MAG3CvC,KAAKyC,IAAI1C,GAEFC,KAAKkC,MAqBhB,OAlBSF,gBAAP,SAAWjC,GACT,GAAuB,iBAAZA,EACT,IAAK,IAAIuC,KAAOvC,EACVA,EAAQ+C,eAAeR,KACzBtC,KAAKkC,MAAMI,GAAOvC,EAAQuC,KAM3BN,uBAAP,WACE,OAAOhC,KAAK6C,YAGPb,mBAAP,SAAc3B,GACZL,KAAK6C,YAAa"}